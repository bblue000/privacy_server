
var util = require('util'),
    mongodb = require('mongodb'),
    MongoClient = require('mongodb').MongoClient,
    Server = require('mongodb').Server;
	
var exp = exports;
var dbs = {};

var defaultServer = {
	'host' : "localhost",
    'port' : 27017,
    'user' : 'yy',
    'password' : 'yy',
    'db_name' : 'firstlove' 
};

exp.def = function() {
	return __config(defaultServer);
};

exp.createBy = function(dbConfig) {
	return __config(dbConfig);
};

function __config(dbConfig) {
	var host = dbConfig['host'],
        port = dbConfig['port'],
        dbName = dbConfig['db_name'],
        dbUrl = util.format("mongodb://%s:%s/%s", host, port, dbName);

	// var mydb = dbs[dbUrl];
		
	var mydb = function () {
		
	};
	
	mydb.connect = function(callback) {
		if (mydb.__db) {
			callback(null, __db);
			return ;
		}
		MongoClient.connect(dbUrl, function(err, db) {
			if (err){
				console.log('connect err', err);
				callback(err);
			}else{
				mydb.__db = db;
				console.log('connect accessed to db');
				callback(null, db);
			}
		});
	};
	
	mydb.collection = function(tableName, callback) {
		mydb.__db.collection(tableName, function(err, collection){
			if (err){
				console.log('collection err', err);
				callback(err);
			}else{
				mydb.__connection = collection;
				mydb.__connectionName = tableName;
				console.log('collection collected');
				callback(null, collection);
			}
		});
	};
	
	mydb.disconnect = function() {
		// mydb.__connection ?
			// (mydb.__db ? mydb.__db.dropCollection(mydb.__connectionName) : {}) 
				// : {};
		mydb.__db ? mydb.__db.close() : {};
		
		mydb.__connectionName = null;
		mydb.__connection = null;
		mydb.__db = null;
		
		dbs[dbUrl] = null;
	};
	
	mydb.insert = function(tableName, insertObj, callback) {
		mydb.connect(function(err, db){
			handleErr(err);
			if (err) return;
			
			mydb.collection(tableName, function(err, collection){
				collection.insert(insertObj, function (err, docs){
					callback ? callback(err, docs) : {};
				});
			});
		});
	};
	
	mydb.find = function(tableName, queryObj, callback) {
		mydb.connect(function(err, db){
			handleErr(err);
			if (err) return;
			
			mydb.collection(tableName, function(err, collection){
				collection.find(queryObj, function (err, docs){
					callback ? callback(err, docs) : {};
				});
			});
		});
	};
	
	function handleErr(err) {
		// if (err) throw err;
		if (err) console.error('mongo client', err);
	}
	
	dbs[dbUrl] = mydb;
	return mydb;
};
/**
var db = exp.def();

db.insert('users', {name:'yy', age:25}, function (err, docs){
	console.log('insert', docs);
	// db.disconnect();
	db.find('users', null, function (err, docs){
		docs.toArray(function(err, results) {
			console.dir(results);
			// Let's close the db
			db.disconnect();
		  });
		
	});
});
**/

